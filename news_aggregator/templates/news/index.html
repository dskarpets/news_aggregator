{% extends 'base.html' %}
{% load translation_tags %}
{% block title %}{% t 'Main Page' %}{% endblock %}
{% block search %}
{% if not hide_search %}
<div class="search-bar">
    <form method="get" action="{% url 'news:index' %}">
        <input type="text" name="search" placeholder="{% t 'Search' %}" value="{{ search_query }}">
        <button type="submit">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M19 19L14.65 14.65" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </form>
</div>
{% endif %}
{% endblock %}
{% block content %}
<div class="container main-container">
    <nav class="tabs">
        <a href="{% url 'news:index' %}" class="tab active">{% t 'Main Page' %}</a>
        {% if user.is_authenticated %}
        <a href="{% url 'news:read_later' %}" class="tab">{% t 'Read Later' %}</a>
        {% endif %}
    </nav>
    <div class="content-wrapper">
        <aside class="filters-sidebar">
            <h3>{% t 'Filters' %}</h3>
            <form method="get" action="{% url 'news:index' %}" id="filterForm">
                <div class="filter-group">
                    <h4>{% t 'Category' %}</h4>
                    <select name="category" id="categorySelect" class="filter-select">
                        <option value="">{% t 'All Categories' %}</option>
                        {% for code, name in categories %}
                        <option value="{{ code }}" {% if selected_category == code %}selected{% endif %}>
                            {% t name %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <h4>{% t 'Source' %}</h4>
                    <select name="source" id="sourceSelect" class="filter-select">
                        <option value="">{% t 'All Sources' %}</option>
                        {% for code, name in sources %}
                        <option value="{{ code }}" {% if selected_source == code %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% if selected_category or selected_source %}
                <button type="button" class="btn-clear-filters" onclick="clearFilters()">
                    {% t 'Clear Filters' %}
                </button>
                {% endif %}
            </form>
        </aside>
        <div class="news-content">
            {% if articles %}
                {% for article in articles %}
                <article class="news-card">
                    <div class="news-image">
                        {% if article.image_url %}
                        <img src="{{ article.image_url }}" alt="{{ article.title }}" onerror="this.parentElement.innerHTML='<div class=\'no-image\'><svg width=\'64\' height=\'64\' viewBox=\'0 0 64 64\' fill=\'none\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M53.3334 8H10.6667C9.19394 8 8.00002 9.19391 8.00002 10.6667V53.3333C8.00002 54.8061 9.19394 56 10.6667 56H53.3334C54.8061 56 56 54.8061 56 53.3333V10.6667C56 9.19391 54.8061 8 53.3334 8Z\' stroke=\'currentColor\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'/><path d=\'M22.6667 26.6667C24.8758 26.6667 26.6667 24.8758 26.6667 22.6667C26.6667 20.4575 24.8758 18.6667 22.6667 18.6667C20.4576 18.6667 18.6667 20.4575 18.6667 22.6667C18.6667 24.8758 20.4576 26.6667 22.6667 26.6667Z\' stroke=\'currentColor\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'/><path d=\'M56 40L42.6667 26.6667L10.6667 56\' stroke=\'currentColor\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'/></svg></div>'">
                        {% else %}
                        <div class="no-image">
                            <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M53.3334 8H10.6667C9.19394 8 8.00002 9.19391 8.00002 10.6667V53.3333C8.00002 54.8061 9.19394 56 10.6667 56H53.3334C54.8061 56 56 54.8061 56 53.3333V10.6667C56 9.19391 54.8061 8 53.3334 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22.6667 26.6667C24.8758 26.6667 26.6667 24.8758 26.6667 22.6667C26.6667 20.4575 24.8758 18.6667 22.6667 18.6667C20.4576 18.6667 18.6667 20.4575 18.6667 22.6667C18.6667 24.8758 20.4576 26.6667 22.6667 26.6667Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M56 40L42.6667 26.6667L10.6667 56" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        {% endif %}
                    </div>
                    <div class="news-info">
                        <h3>{{ article.title }}</h3>
                        <p>{{ article.description|truncatewords:30 }}</p>
                    </div>
                    <button class="add-btn" onclick="handleArticleAction(event, this)"
                            data-url="{{ article.url }}"
                            data-title="{{ article.title }}"
                            data-description="{{ article.description }}"
                            data-content="{{ article.content }}"
                            data-image="{{ article.image_url }}"
                            data-source="{{ article.source }}"
                            data-published="{{ article.published_at }}">
                        {% if article.url in saved_urls %}
                        <svg width="25" height="25" viewBox="0 0 20 20" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 10.5L8.5 14L15 6" stroke="currentColor" stroke-width="2"
                                  stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% else %}
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        {% endif %}
                    </button>
                </article>
                {% endfor %}
                <div class="pagination">
                    {% if current_page > 1 %}
                    <a href="?page={{ current_page|add:-1 }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-btn">← {% t 'Previous' %}</a>
                    {% endif %}
                    <span class="page-number">{{ current_page }}</span>
                    <a href="?page={{ current_page|add:1 }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-btn">{% t 'Next' %} →</a>
                </div>
            {% else %}
                <p class="no-news">{% t 'No news found.' %}</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('categorySelect');
    const sourceSelect = document.getElementById('sourceSelect');

    categorySelect.addEventListener('change', function() {
        if (this.value) {
            sourceSelect.value = '';
        }
        document.getElementById('filterForm').submit();
    });

    sourceSelect.addEventListener('change', function() {
        if (this.value) {
            categorySelect.value = '';
        }
        document.getElementById('filterForm').submit();
    });

    document.querySelectorAll('.news-card').forEach(card => {
        const button = card.querySelector('.add-btn');
        const articleData = {
            url: button.dataset.url,
            title: button.dataset.title,
            description: button.dataset.description,
            content: button.dataset.content,
            image_url: button.dataset.image,
            source: button.dataset.source,
            published_at: button.dataset.published
        };
        card.onclick = function(e) {
            if (!e.target.closest('.add-btn')) {
                storeAndRedirect(articleData);
            }
        };
    });
});

function clearFilters() {
    window.location.href = '{% url "news:index" %}';
}

function handleArticleAction(event, button) {
    event.stopPropagation();
    const articleData = {
        url: button.dataset.url,
        title: button.dataset.title,
        description: button.dataset.description,
        content: button.dataset.content,
        image_url: button.dataset.image,
        source: button.dataset.source,
        published_at: button.dataset.published
    };
    {% if user.is_authenticated %}
        saveArticle(articleData);
    {% else %}
        if (confirm('{% t "Please log in to save articles." %}')) {
            window.location.href = '{% url "users:login" %}?next={% url "news:index" %}';
        }
    {% endif %}
}

function saveArticle(data) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "news:save_article" %}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    for (const key in data) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = data[key] || '';
        form.appendChild(input);
    }
    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrfmiddlewaretoken';
    csrf.value = csrfToken;
    form.appendChild(csrf);
    document.body.appendChild(form);
    form.submit();
}

function storeAndRedirect(data) {
    fetch('{% url "news:store_article" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams(data)
    }).then(() => {
        window.location.href = `/article/${encodeURIComponent(data.url)}/`;
    });
}
</script>
{% endblock %}
